---
layout: post
title: firewall
---
Use iptables to secure netlink infrastructure.

### Where the rules files go
In Arch, the usual /etc/iptables/iptables.rules
In Gentoo, the rules are restored from /var/lib/iptables/rules-save
In Debian, wiki says to create /etc/network/if-pre-up.d/iptables (chmod +x)

### Rules Basic Template
Based on: https://wiki.archlinux.org/index.php/Simple_Stateful_Firewall

```
    *filter
    :INPUT DROP [0:0]
    :FORWARD DROP [0:0]
    :OUTPUT ACCEPT [0:0]
    :TCP - [0:0]
    :UDP - [0:0]
## === BEGIN: First Rule ======================================
# Keep before ping limiting rules to limit pings per connection
    -I INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
## === END: First Rule ========================================
## === BEGIN: Ping limiting ===================================
# Keep after 'RELATED, ESTABLISHED' to limit pings per connection
    -A INPUT -p icmp --icmp-type echo-request -m recent --name ping_limiter --set
    -A INPUT -p icmp --icmp-type echo-request -m recent --name ping_limiter --update --hitcount 6 --seconds 10 -j DROP
    -A INPUT -p icmp --icmp-type echo-request -j ACCEPT
## === END: Ping limiting =====================================
## === BEGIN: General Rules ===================================
# Extra protection against spoofing attacks
    -I INPUT ! -i lo -s 127.0.0.0/8 -j DROP
# Accept all traffic coming from localhost
    -A INPUT -i lo -j ACCEPT
    -A INPUT -d 127.0.0.0/8 -j REJECT
    -A INPUT -m conntrack --ctstate INVALID -j DROP
    -A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -m conntrack --ctstate NEW -j TCP
    -A INPUT -p udp -m conntrack --ctstate NEW -j UDP
## === END: General Rules =====================================
## === BEGIN: Services ========================================
## NTP
#-A UDP -p tcp -i eth0 -s 192.168.12.0/24 --dport 123 -j ACCEPT
## SSH
    -A TCP -p tcp -i eth0 -s 192.168.12.0/24 --dport 2151 -j ACCEPT
## TRANSMISSION
#-A TCP -p tcp -i tun+ --dport 50460 -j ACCEPT
#-A UDP -p udp -i tun+ --dport 50460 -j ACCEPT
    -A OUTPUT -m owner --uid-owner transmission -d 192.168.12.12 -j ACCEPT
    -A OUTPUT -m owner --uid-owner transmission -d 192.168.12.18 -j ACCEPT
    -A OUTPUT -m owner --uid-owner transmission -d 192.168.12.113 -j ACCEPT
    -A OUTPUT -m owner --uid-owner transmission ! -o tun+ -j REJECT
## TRANSMISSION-REMOTE-CLI
    -A TCP -p tcp -s 192.168.12.12 --dport 9091 -j ACCEPT
    -A TCP -p tcp -s 192.168.12.18 --dport 9091 -j ACCEPT
    -A TCP -p tcp -s 192.168.12.113 --dport 9091 -j ACCEPT
## === END: Services ==========================================
## === BEGIN: Trick Port Scanning =============================
    -I TCP -p tcp -m recent --update --seconds 60 --name TCP-PORTSCAN -j REJECT --reject-with tcp-rst
    -I UDP -p udp -m recent --update --seconds 60 --name UDP-PORTSCAN -j REJECT --reject-with port-unreach
    -A INPUT -p tcp -m recent --set --name TCP-PORTSCAN -j REJECT --reject-with tcp-rst
    -A INPUT -p udp -m recent --set --name UDP-PORTSCAN -j REJECT --reject-with icmp-port-unreach
## === END: Trick Port Scanning ===============================
## === BEGIN: Last Rule =======================================
# This rule must be kept at the end, regardless if port-scan or ping limit is used.
    -A INPUT -j REJECT --reject-with icmp-proto-unreachable
## === END: Last Rule =========================================
    COMMIT
```

### Internet Connection Sharing
Involves adding additional rules

```
*nat
:PREROUTING ACCEPT [48:4139]
:INPUT ACCEPT [20:1898]
:OUTPUT ACCEPT [2314:104209]
:POSTROUTING ACCEPT [2314:104209]
-A POSTROUTING -s 172.16.42.0/24 -o br0 -j MASQUERADE
COMMIT
*filter
:INPUT ACCEPT [2306:105504]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [2549:124453]
:fw-interfaces - [0:0]
:fw-open - [0:0]
-A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -j fw-interfaces
-A FORWARD -j fw-open
-A FORWARD -j REJECT --reject-with icmp-host-unreachable
-A fw-interfaces -i tpl0 -j ACCEPT
COMMIT
```


## References
[Archwiki](https://wiki.archlinux.org/index.php/Simple_Stateful_Firewall)
[Debwiki](https://wiki.debian.org/iptables)

